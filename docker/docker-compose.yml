version: "3.8"

services:
  selenoid-1:
    image: aerokube/selenoid:latest
    container_name: selenoid-1
    networks:
      - selenoid-net
    ports:
      - "4444:4444"        # опционально – для отладки напрямую
    volumes:
      - ./browsers.json:/etc/selenoid/browsers.json:ro
      - ./logs:/opt/selenoid/logs
      - ./video:/opt/selenoid/video
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - TZ=Europe/Moscow
      - OVERRIDE_VIDEO_OUTPUT_DIR=/opt/selenoid/video

  selenoid-2:
    image: aerokube/selenoid:latest
    container_name: selenoid-2
    networks:
      - selenoid-net
    # порты наружу можно не публиковать – GGR ходит по внутреннему DNS
    volumes:
      - ./browsers.json:/etc/selenoid/browsers.json:ro
      - ./logs:/opt/selenoid/logs
      - ./video:/opt/selenoid/video
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - TZ=Europe/Moscow
      - OVERRIDE_VIDEO_OUTPUT_DIR=/opt/selenoid/video

  selenoid-ui:
    image: aerokube/selenoid-ui:latest
    container_name: selenoid-ui
    networks:
      - selenoid-net
    depends_on:
      - selenoid-1
    environment:
      - TZ=Europe/Moscow
    command: ["--selenoid-uri", "http://selenoid-1:4444"]
    ports:
      - "8080:8080"

  ggr:
    image: aerokube/ggr:latest-release
    container_name: ggr
    networks:
      - selenoid-net
    depends_on:
      - selenoid-1
      - selenoid-2
    ports:
      - "4445:4444"
    restart: always
    volumes:
      - ./config/users.htpasswd:/etc/grid-router/users.htpasswd:ro
      - ./config/quota:/etc/grid-router/quota:ro

  ggr-ui:
    image: aerokube/ggr-ui:latest-release
    container_name: ggr-ui
    networks:
      - selenoid-net
    depends_on:
      ggr:
        condition: service_started
    environment:
      - GGR_HOST=ggr
      - GGR_PORT=4444
    ports:
      - "8888:8888"
    restart: always

networks:
  selenoid-net:
    driver: bridge
