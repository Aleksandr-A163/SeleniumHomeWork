- name: ğŸš€ Deploy Selenoid and UI via Docker
  hosts: localhost
  become: yes

  tasks:
    - name: ğŸ§© Add Docker GPG key and repository
      block:
        - name: Add Docker GPG key
          apt_key:
            url: https://download.docker.com/linux/ubuntu/gpg
            state: present

        - name: Add Docker repository
          apt_repository:
            repo: "deb [arch=amd64] https://download.docker.com/linux/ubuntu {{ ansible_lsb.codename }} stable"
            state: present

    - name: ğŸ§© Ensure Docker and Compose installed
      apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-compose-plugin
        state: present
        update_cache: yes

    - name: ğŸ“ Create directories for Selenoid
      file:
        path: "{{ item }}"
        state: directory
        mode: "0755"
      loop:
        - "./video"
        - "./logs"

    - name: ğŸ§  Copy browsers.json config
      copy:
        src: "./browsers.json"
        dest: "./browsers.json"
        mode: "0644"

    - name: ğŸ“¦ Deploy Selenoid and UI
      command: docker compose up -d
      args:
        chdir: "{{ playbook_dir }}"
      register: compose_output

    - name: â³ Wait for Selenoid to be ready
      uri:
        url: "http://{{ ansible_default_ipv4.address }}:4444/status"
        method: GET
        return_content: yes
        status_code: 200
      register: selenoid_status
      retries: 10
      delay: 5
      until: selenoid_status.status == 200

    - name: âœ… Show success message
      debug:
        msg:
          - "Selenoid successfully deployed!"
          - "ğŸ§ª Selenium endpoint: http://{{ ansible_default_ipv4.address }}:4444/wd/hub"
          - "ğŸ–¥ UI: http://{{ ansible_default_ipv4.address }}:8080"
